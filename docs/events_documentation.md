# Документация по EventData.ts, EventsStore.ts и EventStructure.ts

## 1. EventData.ts

Файл `src/6-entities/stores/Events/EventData.ts` определяет тип `EventData`. Этот тип представляет собой базовую структуру данных события, предназначенную для сохранения во внешнем хранилище или получения из него. Он включает в себя следующие поля:

-   **`name`**: Наименование события (обязательное поле).
-   **`comment`**: Комментарий к событию (необязательно).
-   **`project`**: Наименование проекта, к которому относится событие (необязательно).
-   **`repeat`**: Строка шаблона `zcrone` для повторяющихся событий (необязательно).
-   **`start`**: Дата начала события в формате 'YYYY.MM.DD' (обязательно).
-   **`time`**: Время начала события в формате 'H:MM' (необязательно).
-   **`duration`**: Длительность события в формате 'Dd H:MM' (необязательно).
-   **`end`**: Дата завершения события в формате 'YYYY.MM.DD' (необязательно).
-   **`credit`**: Сумма поступления на счет (необязательно).
-   **`debit`**: Сумма списания со счета (необязательно).

`EventData` служит простым "сырым" представлением события, которое легко сериализуется и десериализуется для взаимодействия с внешними системами хранения.

## 2. EventStructure.ts

Файл `src/6-entities/stores/Events/EventStructure.ts` определяет внутренние структуры данных для событий, которые используются в логике приложения, а также функции для преобразования между этими внутренними структурами и типом `EventData`.

Основные экспорты:

-   **`IEventStructure` (интерфейс)**: Базовый интерфейс, описывающий общие свойства для одиночных и повторяющихся событий. Поля здесь представлены уже в обработанном формате (например, `timestamp` для дат, секунды для времени и длительности).
-   **`SingleEventStructure` (тип)**: Представляет структуру одиночного события, используемую внутри хранилища. Включает поля `id` (уникальный идентификатор), `projectId` (индекс проекта), `days` (длительность в днях) и другие поля, конвертированные в числовые форматы (`timestamp`, секунды).
-   **`RepeatableEventStructure` (тип)**: Представляет структуру повторяющегося события. Также имеет `id`, `projectId`, `repeat` (строка `zcrone` для расписания) и другие поля, адаптированные для внутренних расчетов.

Функции преобразования:

-   **`eventDataToIEventStructure(e: EventData): IEventStructure`**: Преобразует данные `EventData` из внешнего хранилища во внутреннюю структуру `IEventStructure`. Эта функция выполняет парсинг и преобразование строковых представлений дат, времени и длительности в числовые форматы (`timestamp`, секунды) с использованием библиотек `DateTime` и `ZCron`.
-   **`singleEventStructureToEventData(e: SingleEventStructure): EventData`**: Преобразует внутреннюю структуру одиночного события `SingleEventStructure` обратно в формат `EventData` для сохранения.
-   **`repeatableEventStructureToEventData(e: RepeatableEventStructure): EventData`**: Преобразует внутреннюю структуру повторяющегося события `RepeatableEventStructure` обратно в формат `EventData` для сохранения.

`EventStructure.ts` обеспечивает "мост" между "сырыми" данными `EventData` и богатой логикой управления событиями в `EventsStore`, предоставляя удобные для обработки структуры и функции конвертации.

## 3. EventsStore.ts

Файл `src/6-entities/stores/Events/EventsStore.ts` определяет класс `EventsStore`, который является центральным хранилищем MobX для управления состоянием и логикой, связанной с событиями, в приложении.

**Назначение `EventsStore`:**

-   **Управление жизненным циклом событий**: `EventsStore` предоставляет методы для создания, удаления, обновления, завершения, отмены завершения, перемещения (сдвига) и копирования событий.
-   **Классификация событий**: События организуются в три внутренних списка:
    -   `completed`: Список завершенных одиночных событий (`SingleEventStructure[]`).
    -   `planned`: Список запланированных одиночных событий (`SingleEventStructure[]`).
    -   `plannedRepeatable`: Список запланированных повторяющихся событий (`RepeatableEventStructure[]`).
-   **Преобразование данных**: Выполняет преобразования между внешним форматом `EventData` и внутренними структурами (`SingleEventStructure`, `RepeatableEventStructure`), используя функции из `EventStructure.ts`.
-   **Взаимодействие с `ProjectsStore`**: Принимает экземпляр `ProjectsStore` в своем конструкторе и использует его для получения `projectId` и управления счетчиками событий, связанных с проектами.
-   **Инициализация и сохранение**: Предоставляет методы `init()` для загрузки данных в хранилище и `prepareToSave()` для подготовки данных к сохранению.
-   **Работа с датами и расписаниями**: Использует библиотеки `ZCron` для сложной логики повторяющихся событий и `DateTime` для манипуляций с датами и временем.
-   **Уведомления об изменениях**: Содержит колбэк `onChangeList`, который вызывается при каждом изменении списков событий, сигнализируя другим частям приложения о необходимости обновления.

**Связь с `EventData.ts` и `EventStructure.ts`:**

-   `EventsStore` принимает `EventData[]` при инициализации (`init`) и преобразует их во внутренние структуры (`SingleEventStructure`, `RepeatableEventStructure`) с помощью `eventDataToIEventStructure`.
-   При подготовке данных к сохранению (`prepareToSave`) `EventsStore` преобразует свои внутренние структуры обратно в `EventData[]` с помощью `singleEventStructureToEventData` и `repeatableEventStructureToEventData`.
-   Все CRUD-операции (создание, чтение, обновление, удаление) внутри `EventsStore` работают с `SingleEventStructure` и `RepeatableEventStructure`, используя `IEventStructure` как общий интерфейс при необходимости.

## Использование в приложении

1.  **Инициализация**: Класс `EventsStore` инстанцируется в файле `src/root.ts`. Он получает экземпляр `ProjectsStore` в качестве зависимости через свой конструктор:
    ```typescript
    // Пример из src/root.ts (упрощено)
    export const projectsStore = new ProjectsStore();
    export const eventsStore = new EventsStore(projectsStore);
    ```
2.  **Центральное хранилище (`MainStore`)**: Экземпляр `eventsStore` затем передается в конструктор `MainStore` (определенного в `src/6-entities/stores/MainStore.ts`), который является главным хранилищем приложения и координирует работу различных хранилищ.
    ```typescript
    // Пример из src/6-entities/stores/MainStore.ts (упрощено)
    export class MainStore {
      eventsStore: EventsStore;
      // ... другие хранилища
      constructor(projectsStore: ProjectsStore, eventsStore: EventsStore, /* ... */) {
        this.projectsStore = projectsStore;
        this.eventsStore = eventsStore;
        // ...
      }
    }
    ```
3.  **Предоставление в React-компоненты**: В `src/index.tsx`, который является точкой входа React-приложения, инстанцированные хранилища (включая `eventsStore` через `mainStore`) импортируются из `src/root.ts` и предоставляются всему дереву компонентов React через `StoreProvider`. Это позволяет компонентам получать доступ к состоянию событий и взаимодействовать с `EventsStore` для отображения и модификации данных.

Таким образом, `EventData.ts`, `EventStructure.ts` и `EventsStore.ts` представляют собой ключевые компоненты подсистемы управления событиями, обеспечивающие структурированное хранение, преобразование и манипуляцию данными событий в приложении.