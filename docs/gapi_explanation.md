# Документация по gapi.ts

## Обзор

Файл `gapi.ts` инкапсулирует взаимодействие с Google API, предоставляя статические методы для аутентификации, работы с файлами и папками на Google Drive. Он абстрагирует низкоуровневые вызовы `gapi.client` и `google.accounts.oauth2` в более удобный и типизированный интерфейс.

## Глобальные переменные и константы

*   `API_KEY`: Ключ API для доступа к Google Drive. Берется из переменных окружения.
*   `CLIENT_ID`: Идентификатор клиента для OAuth2. Берется из переменных окружения.
*   `SCOPES`: Области доступа (разрешения), которые запрашивает приложение у пользователя Google. Включает доступ к файлам Drive (чтение/запись), только чтение и доступ к папкам приложения (`appfolder`).
*   `DISCOVERY_DOC`: URL документа обнаружения для Google Drive API v3.

## Вспомогательные функции

### `prom(gapiCall: (arg: any) => Promise<any>, argObj: any)`

Хелпер-функция, оборачивающая вызовы Google API, возвращающие `Promise`, для стандартизированной обработки ответа и ошибок.
*   **`gapiCall`**: Функция Google API, которая возвращает `Promise`.
*   **`argObj`**: Объект аргументов для `gapiCall`.

Обрабатывает ошибки аутентификации (401, 403 PERMISSION_DENIED), сбрасывая токен и вызывая `expiredTokenHandle`.

### `loadScriptPromise(url: string)`

Загружает JavaScript-скрипт по указанному URL, возвращая `Promise`, который разрешается после загрузки скрипта или отклоняется в случае ошибки.
*   **`url`**: URL скрипта для загрузки.

## Интерфейсы

### `DriveFileMetadata`

Интерфейс, описывающий метаданные файла или папки на Google Drive.

*   **`id: string`**: Идентификатор файла/папки.
*   **`name: string`**: Имя файла/папки.
*   **`mimeType: string`**: MIME-тип файла/папки (например, `'application/vnd.google-apps.folder'` для папки, `'text/plain'` для текстового файла).
*   **`parents?: string[]`**: Массив идентификаторов родительских папок.
*   **`iconLink?: string`**: Ссылка на иконку файла.
*   **`webViewLink?: string`**: Ссылка для просмотра файла в браузере.

## Класс `GAPI`

Класс со статическими методами для взаимодействия с Google API.

### `GAPI.tokenClient`

Экземпляр клиента `google.accounts.oauth2.TokenClient`, используемый для запросов токена аутентификации.

### `static async init({onSuccess, onFailure, onSignIn, onExpiredToken})`

Асинхронная функция инициализации модулей Google API (GSI и GAPI).
*   **`onSuccess: () => void`**: Колбэк, вызываемый после успешной инициализации GAPI.
*   **`onFailure: () => void`**: Колбэк, вызываемый в случае ошибки инициализации.
*   **`onSignIn: () => void`**: Колбэк, вызываемый после успешного входа/аутентификации пользователя (когда получен `tokenResponse`).
*   **`onExpiredToken: () => void`**: Колбэк, вызываемый при истечении срока действия токена аутентификации.

### `static logIn(prompt = '')`

Функция-промис для авторизации пользователя в Google сервисах. Запрашивает токен авторизации.
*   **`prompt: string`**: Строка, передаваемая в Google API для управления поведением запроса аутентификации (например, `'select_account'` для принудительного выбора аккаунта). По умолчанию пустая строка.

### `static logOut()`

Функция для отзыва токена авторизации и выхода пользователя из Google.

### `static isLoggedIn(): boolean`

Проверяет, авторизован ли пользователь в Google.
*   Возвращает `true`, если токен аутентификации существует, `false` в противном случае.

### `static isGranted(scope: string, ...scopes: string[]): boolean`

Проверяет, предоставлены ли приложению все указанные разрешения (scopes).
*   **`scope: string`**: Обязательная первая область доступа.
*   **`...scopes: string[]`**: Дополнительные области доступа.

### `static async createFileOrFolder(name: string, mimeType: string = 'text/plain', parents: string[]): Promise<DriveFileMetadata>`

Создает новый файл или папку на Google Drive.
*   **`name: string`**: Имя создаваемого файла или папки.
*   **`mimeType: string`**: MIME-тип создаваемого элемента. По умолчанию `'text/plain'`. Для папок используется `'application/vnd.google-apps.folder'`.
*   **`parents: string[]`**: **Массив идентификаторов родительских папок.** Это критически важно для определения местоположения файла/папки.
    *   **Примеры значений:**
        *   `['root']`: Создаст элемент в корневом каталоге "Мой диск" пользователя.
        *   `['appDataFolder']`: Создаст элемент в корневой папке приложения (`appDataFolder`).
        *   `['folder_id']`: Создаст элемент в папке с указанным `folder_id`.
        *   **Для подпапок `appDataFolder`**: Google Drive API обычно поддерживает явное указание ID подпапки в качестве родителя. Если элемент создается в подпапке `X` внутри `appDataFolder` с `parents: [ID_X]`, он должен появиться только в папке `X`. Если возникают дубликаты в корне `appDataFolder`, это может указывать на особенности поведения API, при которых элементы внутри `appDataFolder` неявно ассоциируются с его корнем.

### `static async upload(fileId: string, content: string | object)`

Загружает (обновляет) содержимое файла на Google Drive.
*   **`fileId: string`**: Идентификатор файла, который нужно обновить.
*   **`content: string | object`**: Новое содержимое файла. Может быть строкой или объектом (будет сериализован в JSON).

### `static async download(fileId: string)`

Загружает содержимое файла с Google Drive.
*   **`fileId: string`**: Идентификатор файла, содержимое которого нужно загрузить.
*   Возвращает содержимое файла (строку или объект, если это JSON).

### `static async find(query: string, folderId: string | null = null, fields: string = 'id, name, mimeType, parents, iconLink, webViewLink', spaces: string = 'drive'): Promise<DriveFileMetadata[]>`

Получает список файлов и папок, соответствующих запросу `query` и другим параметрам.
*   **`query: string`**: Строка запроса в формате Google Drive API (например, `'name = "MyFile"'`). Может быть пустой строкой.
*   **`folderId: string | null`**: **Идентификатор родительской папки, в которой производится поиск.**
    *   **Примеры значений:**
        *   `'root'`: Поиск в корне "Мой диск".
        *   `'appDataFolder'`: Поиск в корне папки приложения.
        *   `'some_folder_id'`: Поиск в конкретной папке по ее ID.
        *   `null`: Если `folderId` равен `null`, то параметр `'${folderId}' in parents` не добавляется к запросу `q`. В этом случае поиск будет ограничен только параметром `spaces`.
    *   **Назначение:** Используется для построения части запроса `q` вида `'${folderId}' in parents`. Это ограничивает поиск прямыми потомками указанной папки. Важно отметить, что `GAPI.find` сейчас всегда добавляет это условие, если `folderId` предоставлен.
*   **`fields: string`**: Строка, указывающая, какие поля метаданных нужно получить для каждого файла/папки (например, `'id, name, mimeType'`). По умолчанию возвращаются основные поля.
*   **`spaces: string`**: **Пространство Google Drive, в котором производится поиск.**
    *   **Примеры значений:**
        *   `'drive'` (по умолчанию): Поиск в "Моем диске" пользователя.
        *   `'appDataFolder'`: Поиск в папке приложения.
        *   `'photos'`: Поиск в Google Фото.
    *   **Назначение:** Ограничивает поиск определенным пространством Drive. Это особенно важно для `appDataFolder`, так как его содержимое изолировано от обычного Drive.

### `static async listFolderContents(folderId: string = 'root', fields: string = 'id, name, mimeType, parents, iconLink, webViewLink', spaces: string = 'drive'): Promise<DriveFileMetadata[]>`

Получает содержимое указанной папки. Является оберткой для `GAPI.find` с пустым запросом `query`.
*   **`folderId: string`**: **Идентификатор папки, содержимое которой нужно получить.** По умолчанию `'root'`.
    *   **Примеры значений:** `'root'`, `'appDataFolder'`, или ID любой другой папки.
    *   **Назначение:** Этот `folderId` напрямую передается в `GAPI.find` и используется там для построения запроса `q` с условием `'${folderId}' in parents`.
*   **`fields: string`**: Те же, что и в `GAPI.find`.
*   **`spaces: string`**: Те же, что и в `GAPI.find`.

### `static async getFileMetadata(fileId: string): Promise<DriveFileMetadata>`

Получает полные метаданные файла или папки по его ID.
*   **`fileId: string`**: Идентификатор файла или папки.

### `static async deleteFile(fileId: string): Promise<boolean>`

Удаляет файл или папку по его ID.
*   **`fileId: string`**: Идентификатор файла или папки для удаления.
*   Возвращает `true` в случае успешного удаления, `false`, если файл не найден (статус 404), или выбрасывает ошибку в других случаях.
